// ============================================================================
// Test Advanced Math Functions (sqrt, pow, floor, ceil, round)
// ============================================================================

// Import math library macros
%macro GEN_SQRT 1
func:sqrt_%1 = *%1(%1:value) {
    %1:val = @llvm_sqrt_%1(value);
    return val;
};
%endmacro

%macro GEN_FLOOR 1
func:floor_%1 = *%1(%1:value) {
    %1:val = @llvm_floor_%1(value);
    return val;
};
%endmacro

%macro GEN_CEIL 1
func:ceil_%1 = *%1(%1:value) {
    %1:val = @llvm_ceil_%1(value);
    return val;
};
%endmacro

%macro GEN_POW 1
func:pow_%1 = *%1(%1:base, %1:exponent) {
    %1:val = @llvm_pow_%1(base, exponent);
    return val;
};
%endmacro

%macro GEN_POW_INT 1
func:pow_%1 = *%1(%1:base, %1:exponent) {
    if (exponent < 0) {
        fail(1);
    }
    if (exponent == 0) {
        return 1;
    }
    %1:result_val = 1;
    %1:i = 0;
    while (i < exponent) {
        result_val = result_val * base;
        i = i + 1;
    }
    return result_val;
};
%endmacro

%macro GEN_ISQRT 1
func:isqrt_%1 = *%1(%1:n) {
    if (n < 0) {
        fail(1);
    }
    if (n == 0) {
        return 0;
    }
    if (n == 1) {
        return 1;
    }
    
    %1:x = n;
    %1:y = 0;
    while (y != x) {
        y = x;
        x = (x + (n / x)) / 2;
    }
    return x;
};
%endmacro

// Generate test functions
GEN_SQRT(flt64)
GEN_FLOOR(flt64)
GEN_CEIL(flt64)
GEN_POW(flt64)
GEN_POW_INT(int32)
GEN_ISQRT(int32)

// ----------------------------------------------------------------------------
// Test floating point sqrt
// ----------------------------------------------------------------------------
func:test_sqrt = *int8() {
    // sqrt(16.0) should be 4.0
    flt64:v1 = sqrt_flt64(16.0) ? 0.0;
    
    // sqrt(2.0) should be ~1.414
    flt64:v2 = sqrt_flt64(2.0) ? 0.0;
    
    // sqrt(0.0) should be 0.0
    flt64:v3 = sqrt_flt64(0.0) ? 0.0;
    
    return 0;
};

// ----------------------------------------------------------------------------
// Test floor/ceil
// ----------------------------------------------------------------------------
func:test_floor_ceil = *int8() {
    // floor(3.7) should be 3.0
    flt64:f1 = floor_flt64(3.7) ? 0.0;
    
    // floor(-3.7) should be -4.0
    flt64:f2 = floor_flt64(-3.7) ? 0.0;
    
    // ceil(3.2) should be 4.0
    flt64:c1 = ceil_flt64(3.2) ? 0.0;
    
    // ceil(-3.2) should be -3.0
    flt64:c2 = ceil_flt64(-3.2) ? 0.0;
    
    return 0;
};

// ----------------------------------------------------------------------------
// Test floating point power
// ----------------------------------------------------------------------------
func:test_pow_float = *int8() {
    // 2.0^3 should be 8.0
    flt64:p1 = pow_flt64(2.0, 3.0) ? 0.0;
    
    // 5.0^2 should be 25.0
    flt64:p2 = pow_flt64(5.0, 2.0) ? 0.0;
    
    // 2.0^0 should be 1.0
    flt64:p3 = pow_flt64(2.0, 0.0) ? 0.0;
    
    return 0;
};

// ----------------------------------------------------------------------------
// Test integer power
// ----------------------------------------------------------------------------
func:test_pow_int = *int8() {
    // 2^10 should be 1024
    int32:p1 = pow_int32(2, 10) ? 0;
    if (p1 != 1024) {
        return 1;
    }
    
    // 5^3 should be 125
    int32:p2 = pow_int32(5, 3) ? 0;
    if (p2 != 125) {
        return 1;
    }
    
    // 3^0 should be 1
    int32:p3 = pow_int32(3, 0) ? 0;
    if (p3 != 1) {
        return 1;
    }
    
    return 0;
};

// ----------------------------------------------------------------------------
// Test integer square root
// ----------------------------------------------------------------------------
func:test_isqrt = *int8() {
    // isqrt(144) should be 12
    int32:s1 = isqrt_int32(144) ? 0;
    if (s1 != 12) {
        return 1;
    }
    
    // isqrt(100) should be 10
    int32:s2 = isqrt_int32(100) ? 0;
    if (s2 != 10) {
        return 1;
    }
    
    // isqrt(0) should be 0
    int32:s3 = isqrt_int32(0) ? 0;
    if (s3 != 0) {
        return 1;
    }
    
    // isqrt(1) should be 1
    int32:s4 = isqrt_int32(1) ? 0;
    if (s4 != 1) {
        return 1;
    }
    
    return 0;
};

// ----------------------------------------------------------------------------
// Main test runner
// ----------------------------------------------------------------------------
func:main = *int8() {
    int8:result_val = 0;
    
    // Run all tests
    result_val = test_sqrt() ? 1;
    if (result_val != 0) {
        return 1;
    }
    
    result_val = test_floor_ceil() ? 1;
    if (result_val != 0) {
        return 1;
    }
    
    result_val = test_pow_float() ? 1;
    if (result_val != 0) {
        return 1;
    }
    
    result_val = test_pow_int() ? 1;
    if (result_val != 0) {
        return 1;
    }
    
    result_val = test_isqrt() ? 1;
    if (result_val != 0) {
        return 1;
    }
    
    // All tests passed
    return 0;
};
