// Comprehensive test of bitwise compound assignments with proper types
// Tests the i8 type fix and all 5 new bitwise compound operators

func:test_all_operators = *int8() {
    // Test &= (AND assignment)
    uint8:a = 0xFF;
    a &= 0x0F;
    
    // Test |= (OR assignment) 
    uint8:b = 0x40;
    b |= 0x08;
    
    // Test ^= (XOR assignment)
    uint8:c = 0xFF;
    c ^= 0x55;
    
    // Test <<= (left shift assignment)
    uint8:d = 1;
    d <<= 4;
    
    // Test >>= (right shift assignment)
    uint8:e = 0x80;
    e >>= 2;
    
    // Verify all results
    int8:success = 1;
    if (a != 0x0F) { success = 0; }
    if (b != 0x48) { success = 0; }
    if (c != 0xAA) { success = 0; }
    if (d != 16) { success = 0; }
    if (e != 0x20) { success = 0; }
    
    return success;
};

func:test_rex_calculation = *uint8() {
    // Real-world use case: Calculate REX prefix byte for x86-64
    // REX = 0x40 | W_bit | R_bit | B_bit
    
    uint8:rex = 0x40;
    
    // W bit (64-bit operand)
    rex |= 0x08;
    
    // R bit (extension of ModR/M reg field)
    // (not needed in this example)
    
    // B bit (extension of ModR/M r/m field)
    // (not needed in this example)
    
    // Result should be 0x48 (REX.W for 64-bit operation)
    return rex;
};

func:test_modrm_calculation = *uint8() {
    // Real-world use case: Calculate ModR/M byte for x86-64
    // ModR/M = (mod << 6) | (reg << 3) | rm
    
    uint8:modrm = 0;
    
    // mod = 11 (register direct mode)
    modrm |= (uint8)3 << 6;
    
    // reg = 7 (RDI register)
    modrm |= (uint8)7 << 3;
    
    // rm = 0 (RAX register)
    modrm |= (uint8)0;
    
    // Result should be 0xF8 (mod=11, reg=7, rm=0)
    return modrm;
};

func:main = *int8() {
    print("========================================");
    print("  Comprehensive Bitwise Operator Test");
    print("========================================");
    
    int8:test1 = test_all_operators();
    if (test1 == 1) {
        print("✓ All 5 bitwise compound operators: PASS");
    } else {
        print("✗ Bitwise compound operators: FAIL");
    }
    
    uint8:rex = test_rex_calculation();
    if (rex == 0x48) {
        print("✓ REX prefix calculation: PASS (0x48)");
    } else {
        print("✗ REX prefix calculation: FAIL");
    }
    
    uint8:modrm = test_modrm_calculation();
    if (modrm == 0xF8) {
        print("✓ ModR/M byte calculation: PASS (0xF8)");
    } else {
        print("✗ ModR/M byte calculation: FAIL");
    }
    
    print("========================================");
    print("  All tests complete!");
    print("========================================");
    
    return 0;
};
