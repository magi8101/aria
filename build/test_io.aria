// ============================================================================
// Test: Aria File I/O Library
// ============================================================================
// NOTE: Requires syscall intrinsics to be implemented in compiler
// This demonstrates the API design
// ============================================================================

func:main = int8() {
    print("=== Testing Aria File I/O ===");
    
    // ========================================================================
    // Test 1: Write to file
    // ========================================================================
    print("--- Test 1: Writing to file ---");
    
    // Create test data
    uint8:buffer[256];
    buffer[0] = 72;   // 'H'
    buffer[1] = 101;  // 'e'
    buffer[2] = 108;  // 'l'
    buffer[3] = 108;  // 'l'
    buffer[4] = 111;  // 'o'
    buffer[5] = 32;   // ' '
    buffer[6] = 65;   // 'A'
    buffer[7] = 114;  // 'r'
    buffer[8] = 105;  // 'i'
    buffer[9] = 97;   // 'a'
    buffer[10] = 33;  // '!'
    buffer[11] = 10;  // '\n'
    
    // Write to file using high-level function
    result:write_result = write_file("test_output.txt", buffer, 12);
    if (write_result.val < 0) {
        print("ERROR: Failed to write file");
        pass(1);
    }
    print("Successfully wrote 12 bytes to test_output.txt");
    
    // ========================================================================
    // Test 2: Read from file
    // ========================================================================
    print("--- Test 2: Reading from file ---");
    
    uint8:read_buffer[256];
    result:read_result = read_file("test_output.txt", read_buffer, 256);
    if (read_result.val < 0) {
        print("ERROR: Failed to read file");
        pass(1);
    }
    print("Successfully read bytes from test_output.txt");
    
    // ========================================================================
    // Test 3: Low-level file operations
    // ========================================================================
    print("--- Test 3: Low-level operations ---");
    
    // Open file for writing
    result:fd_result = open_write("test_lowlevel.txt");
    int32:fd = 0;
    fd = fd_result.val;
    
    if (fd < 0) {
        print("ERROR: Failed to open file");
        pass(1);
    }
    print("File opened successfully");
    
    // Write data
    uint8:msg[64];
    msg[0] = 76;   // 'L'
    msg[1] = 111;  // 'o'
    msg[2] = 119;  // 'w'
    msg[3] = 32;   // ' '
    msg[4] = 108;  // 'l'
    msg[5] = 101;  // 'e'
    msg[6] = 118;  // 'v'
    msg[7] = 101;  // 'e'
    msg[8] = 108;  // 'l'
    msg[9] = 10;   // '\n'
    
    result:write_low = write(fd, msg, 10);
    if (write_low.val < 0) {
        print("ERROR: Failed to write");
        result:close_result = close(fd);
        pass(1);
    }
    print("Write successful");
    
    // Close file
    result:close_result = close(fd);
    if (close_result.val < 0) {
        print("ERROR: Failed to close file");
        pass(1);
    }
    print("File closed successfully");
    
    // ========================================================================
    // Test 4: Seek and tell
    // ========================================================================
    print("--- Test 4: Seek and tell ---");
    
    // Open for read/write
    result:fd_rw = open_readwrite("test_lowlevel.txt");
    fd = fd_rw.val;
    
    if (fd < 0) {
        print("ERROR: Failed to open file for read/write");
        pass(1);
    }
    
    // Get current position (should be 0)
    result:pos1 = tell(fd);
    print("Initial position obtained");
    
    // Seek to position 4
    result:seek_result = seek(fd, 4, 0);
    if (seek_result.val < 0) {
        print("ERROR: Seek failed");
        result:close_r = close(fd);
        pass(1);
    }
    print("Seeked to position 4");
    
    // Get file size
    result:size = get_file_size(fd);
    if (size.val < 0) {
        print("ERROR: Failed to get file size");
        result:close_r = close(fd);
        pass(1);
    }
    print("File size obtained");
    
    // Rewind to start
    result:rewind_result = rewind(fd);
    if (rewind_result.val < 0) {
        print("ERROR: Rewind failed");
        result:close_r = close(fd);
        pass(1);
    }
    print("Rewound to start");
    
    // Close
    result:close_r = close(fd);
    print("File closed");
    
    // ========================================================================
    // Test 5: Standard I/O
    // ========================================================================
    print("--- Test 5: Standard I/O ---");
    
    // Write to stdout directly
    uint8:stdout_msg[32];
    stdout_msg[0] = 83;   // 'S'
    stdout_msg[1] = 116;  // 't'
    stdout_msg[2] = 100;  // 'd'
    stdout_msg[3] = 111;  // 'o'
    stdout_msg[4] = 117;  // 'u'
    stdout_msg[5] = 116;  // 't'
    stdout_msg[6] = 10;   // '\n'
    
    result:stdout_write = write(1, stdout_msg, 7);
    print("Stdout write test complete");
    
    // Write to stderr
    uint8:stderr_msg[32];
    stderr_msg[0] = 83;   // 'S'
    stderr_msg[1] = 116;  // 't'
    stderr_msg[2] = 100;  // 'd'
    stderr_msg[3] = 101;  // 'e'
    stderr_msg[4] = 114;  // 'r'
    stderr_msg[5] = 114;  // 'r'
    stderr_msg[6] = 10;   // '\n'
    
    result:stderr_write = write(2, stderr_msg, 7);
    print("Stderr write test complete");
    
    // ========================================================================
    print("=== All File I/O Tests Passed! ===");
    pass(0);
};
