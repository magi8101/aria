// Test just calc_rex_byte

// Calculate REX prefix byte (returns 0 if not needed)
func:calc_rex_byte = *uint8(int8:w_flag, int8:r_idx, int8:rm_idx) {
    int8:needs_r = 0;
    int8:needs_b = 0;
    
    if (r_idx > 7) { needs_r = 1; }
    if (rm_idx > 7) { needs_b = 1; }
    
    // Check if REX needed
    int8:needs_rex = 0;
    if (w_flag != 0) { needs_rex = 1; }
    if (needs_r != 0) { needs_rex = 1; }
    if (needs_b != 0) { needs_rex = 1; }
    
    if (needs_rex == 0) {
        return 0;
    }
    
    uint8:rex = 0x40;
    
    if (w_flag != 0) { rex |= 0x08; }
    if (needs_r != 0) { rex |= 0x04; }
    if (needs_b != 0) { rex |= 0x01; }
    
    return rex;
};

func:main = *int8() {
    uint8:r = calc_rex_byte(1, 0, 0);
    return 0;
};
