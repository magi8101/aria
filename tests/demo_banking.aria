// Demo: Banking System - Comprehensive Feature Test
// Tests: Everything - multiple result types, complex error handling, 
//        nested functions, loops, pick statements, memory management,
//        state tracking, validation logic

// Error codes:
// 0 = success
// 1 = insufficient funds
// 2 = invalid account
// 3 = invalid amount (negative or zero)
// 4 = daily limit exceeded
// 5 = account locked

// Account balance tracking (simplified - using single values)
func:create_account = int64(int64:initial_balance) {
    pick(initial_balance) {
        (<0) {
            return {err:3, val:0};
        },
        (*) {
            return {err:0, val:initial_balance};
        }
    }
    return {err:0, val:0};
};

// Validate transaction amount
func:validate_amount = int64(int64:amount) {
    pick(amount) {
        (<=0) {
            return {err:3, val:0};
        },
        (>10000) {
            return {err:4, val:0};  // Daily limit
        },
        (*) {
            return {err:0, val:amount};
        }
    }
    return {err:3, val:0};
};

// Deposit money
func:deposit = int64(int64:current_balance, int64:amount) {
    // Validate amount
    int64:valid_amount = validate_amount(amount) ? 0;
    
    pick(valid_amount) {
        (0) {
            return {err:3, val:current_balance};  // Invalid, return unchanged
        },
        (*) {
            int64:new_balance = current_balance + valid_amount;
            return {err:0, val:new_balance};
        }
    }
    return {err:0, val:current_balance};
};

// Withdraw money
func:withdraw = int64(int64:current_balance, int64:amount) {
    // Validate amount
    int64:valid_amount = validate_amount(amount) ? 0;
    
    pick(valid_amount) {
        (0) {
            return {err:3, val:current_balance};
        },
        (*) {
            // Check sufficient funds
            pick(current_balance) {
                (<amount) {
                    return {err:1, val:current_balance};  // Insufficient
                },
                (*) {
                    int64:new_balance = current_balance - valid_amount;
                    return {err:0, val:new_balance};
                }
            }
            return {err:1, val:current_balance};
        }
    }
    return {err:0, val:current_balance};
};

// Transfer between accounts (returns new balance for sender)
func:transfer = int64(int64:sender_balance, int64:receiver_balance, int64:amount) {
    // Withdraw from sender
    int64:new_sender = withdraw(sender_balance, amount) ? sender_balance;
    
    // Check if withdrawal succeeded by comparing balances
    pick(new_sender) {
        (sender_balance) {
            return {err:1, val:sender_balance};  // Failed, unchanged
        },
        (*) {
            // Deposit to receiver (we return sender's new balance)
            return {err:0, val:new_sender};
        }
    }
    return {err:1, val:sender_balance};
};

// Calculate interest for savings account
func:calculate_interest = int64(int64:balance, int64:rate_percent) {
    // rate_percent is like 5 for 5%
    // Simple interest: balance * rate / 100
    int64:interest = balance * rate_percent / 100;
    int64:new_balance = balance + interest;
    return {err:0, val:new_balance};
};

// Process monthly statement
func:process_monthly_statement = int64(int64:starting_balance, int64:num_transactions) {
    int64:current = starting_balance;
    int64:count = 0;
    
    while(count < num_transactions) {
        // Apply interest each iteration (simulating transactions)
        current = calculate_interest(current, 2) ? current;
        count = count + 1;
    }
    
    return {err:0, val:current};
};

// Calculate loan payment
func:calculate_loan_payment = int64(int64:principal, int64:months, int64:interest_rate) {
    // Simple calculation: principal * (1 + rate/100) / months
    int64:total_with_interest = principal * (100 + interest_rate) / 100;
    int64:monthly_payment = total_with_interest / months;
    
    return {err:0, val:monthly_payment};
};

// Validate account status
func:check_account_status = int8(int64:balance, int64:overdraft_limit) {
    int64:effective_limit = 0 - overdraft_limit;
    
    pick(balance) {
        (<effective_limit) {
            return {err:5, val:0};  // Account locked
        },
        (<0) {
            return {err:0, val:1};  // Overdraft
        },
        (*) {
            return {err:0, val:2};  // Good standing
        }
    }
    return {err:0, val:0};
};

// Run transaction batch
func:run_transaction_batch = *int64() {
    print("Processing transaction batch...");
    
    // Create account with initial deposit
    int64:acc1 = create_account(1000) ? 0;
    int64:acc2 = create_account(500) ? 0;
    
    // Perform several deposits
    acc1 = deposit(acc1, 200) ? acc1;
    acc1 = deposit(acc1, 150) ? acc1;
    
    // Perform withdrawals
    acc1 = withdraw(acc1, 100) ? acc1;
    acc2 = withdraw(acc2, 50) ? acc2;
    
    // Transfer from acc1 to acc2
    acc1 = transfer(acc1, acc2, 300) ? acc1;
    
    // Check final balances (acc1 should be ~950, acc2 should be ~750)
    int64:total = acc1 + acc2;
    
    return total;
};

// Test complex error scenarios
func:test_error_scenarios = *int8() {
    print("Testing error scenarios...");
    
    // Test invalid amounts
    int64:bal1 = 1000;
    bal1 = deposit(bal1, -50) ? bal1;   // Should fail, unchanged
    bal1 = withdraw(bal1, 0) ? bal1;    // Should fail, unchanged
    
    // Test insufficient funds
    int64:bal2 = 100;
    bal2 = withdraw(bal2, 500) ? bal2;  // Should fail, still 100
    
    // Test daily limit
    int64:bal3 = 50000;
    bal3 = withdraw(bal3, 15000) ? bal3;  // Should fail (> 10000 limit)
    
    // Test negative account creation
    int64:bad_acc = create_account(-100) ? 0;  // Should be 0
    
    return 0;
};

// Test interest calculations
func:test_interest = *int64() {
    print("Testing interest calculations...");
    
    // Test simple interest
    int64:bal = 1000;
    bal = calculate_interest(bal, 5) ? bal;  // 5% interest = 1050
    bal = calculate_interest(bal, 10) ? bal; // 10% more = 1155
    
    return bal;
};

// Test loan calculations
func:test_loans = *int64() {
    print("Testing loan calculations...");
    
    // $10000 loan over 12 months at 5% interest
    int64:payment1 = calculate_loan_payment(10000, 12, 5) ? 0;
    
    // $5000 loan over 24 months at 3% interest
    int64:payment2 = calculate_loan_payment(5000, 24, 3) ? 0;
    
    return payment1 + payment2;
};

func:main = *int64() {
    print("=== Banking System Comprehensive Demo ===");
    print("");
    
    // Test basic transactions
    int64:batch_total = run_transaction_batch() ? 0;
    print("Transaction batch complete");
    print("");
    
    // Test error handling
    test_error_scenarios() ? -1;
    print("Error scenario tests complete");
    print("");
    
    // Test interest calculations
    int64:interest_result = test_interest() ? 0;
    print("Interest calculation tests complete");
    print("");
    
    // Test loan calculations  
    int64:loan_result = test_loans() ? 0;
    print("Loan calculation tests complete");
    print("");
    
    // Test monthly statements
    int64:final_balance = process_monthly_statement(1000, 5) ? 0;
    print("Monthly statement processing complete");
    print("");
    
    // Test account status checks
    int8:status1 = check_account_status(1000, 500) ? 0;  // Good
    int8:status2 = check_account_status(-200, 500) ? 0;  // Overdraft
    int8:status3 = check_account_status(-600, 500) ? 0;  // Locked
    print("Account status checks complete");
    print("");
    
    print("=== All Banking Tests Passed! ===");
    return 0;
};
