// Demo: Student Grade Management System
// Tests: multiple types, loops, nested functions, memory allocation

// Error codes:
// 0 = success
// 1 = invalid grade (out of 0-100 range)
// 2 = student not found
// 3 = memory allocation failed

// Validate grade is in range 0-100
func:validate_grade = int8(int8:grade) {
    pick(grade) {
        (<0) {
            return {err:1, val:0};
        },
        (>100) {
            return {err:1, val:0};
        },
        (*) {
            return {err:0, val:grade};
        }
    }
    return {err:1, val:0};
};

// Calculate letter grade from numeric grade
func:get_letter_grade = int8(int8:grade) {
    pick(grade) {
        (>=90) {
            return {err:0, val:65};  // 'A' = 65
        },
        (>=80) {
            return {err:0, val:66};  // 'B' = 66
        },
        (>=70) {
            return {err:0, val:67};  // 'C' = 67
        },
        (>=60) {
            return {err:0, val:68};  // 'D' = 68
        },
        (*) {
            return {err:0, val:70};  // 'F' = 70
        }
    }
    return {err:0, val:70};
};

// Process a single student's grades
func:process_student = int32(int8:grade1, int8:grade2, int8:grade3) {
    // Validate all grades
    int8:g1 = validate_grade(grade1) ? 0;
    int8:g2 = validate_grade(grade2) ? 0;
    int8:g3 = validate_grade(grade3) ? 0;
    
    // Calculate average
    int32:sum = g1 + g2 + g3;
    int32:avg = sum / 3;
    
    return {err:0, val:avg};
};

// Calculate class statistics
func:calculate_class_stats = *int32() {
    // Process multiple students
    int32:student1_avg = process_student(85, 92, 78) ? 0;
    int32:student2_avg = process_student(95, 88, 91) ? 0;
    int32:student3_avg = process_student(72, 68, 75) ? 0;
    int32:student4_avg = process_student(88, 86, 90) ? 0;
    
    // Calculate class average
    int32:total = student1_avg + student2_avg + student3_avg + student4_avg;
    int32:class_avg = total / 4;
    
    return class_avg;
};

// Test grade boundary conditions
func:test_grade_boundaries = *int8() {
    // Test valid grades
    int8:t1 = validate_grade(0) ? -1;    // Minimum valid
    int8:t2 = validate_grade(100) ? -1;  // Maximum valid
    int8:t3 = validate_grade(50) ? -1;   // Middle valid
    
    // Test invalid grades (should return -1 from unwrap default)
    int8:t4 = validate_grade(-10) ? -1;  // Below minimum
    int8:t5 = validate_grade(110) ? -1;  // Above maximum
    
    return 0;
};

// Test letter grade conversion
func:test_letter_grades = *int8() {
    int8:a_grade = get_letter_grade(95) ? 0;  // Should be 65 (A)
    int8:b_grade = get_letter_grade(85) ? 0;  // Should be 66 (B)
    int8:c_grade = get_letter_grade(75) ? 0;  // Should be 67 (C)
    int8:d_grade = get_letter_grade(65) ? 0;  // Should be 68 (D)
    int8:f_grade = get_letter_grade(45) ? 0;  // Should be 70 (F)
    
    return 0;
};

func:main = *int32() {
    print("=== Student Grade Management System ===");
    
    // Test grade validation
    test_grade_boundaries() ? -1;
    print("Grade validation tests passed!");
    
    // Test letter grade conversion
    test_letter_grades() ? -1;
    print("Letter grade conversion tests passed!");
    
    // Calculate and display class statistics
    int32:class_average = calculate_class_stats() ? 0;
    print("Class statistics calculated!");
    
    print("All tests complete!");
    return 0;
};
