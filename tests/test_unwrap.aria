// Test file for Aria UnwrapExpr (? operator)
// Tests result type unwrapping with new uint8 error codes

// Helper function that returns a successful result (explicit result object)
func:make_success = int8(int8:value) {
    return { err:0, val:value };
};

// Helper function that returns an error result
func:make_error = int8(int8:code) {
    return { err:code, val:0 };
};

// Test 1: Unwrap successful result
func:test_unwrap_success = *int8() {
    int8:value = make_success(42) ? -1;  // Should get 42, not -1
    return value;
};

// Test 2: Unwrap error result (should use default)
func:test_unwrap_error = *int8() {
    int8:value = make_error(1) ? -1;  // Should get -1 (default)
    return value;
};

// Test 3: Chain unwrap operations  
func:test_unwrap_chain = *int8() {
    int8:v1 = make_success(10) ? 0;
    int8:v2 = make_success(20) ? 0;
    int8:v3 = make_success(30) ? 0;
    
    int8:sum = v1 + v2 + v3;
    return sum;  // Should be 60
};

// Test 4: Function with auto-wrap and unwrap
func:add_auto = *int8(int8:a, int8:b) {
    return a + b;  // Auto-wrapped to {err:0, val:a+b}
};

func:test_autowrap_unwrap = *int8() {
    int8:res = add_auto(5, 3) ? -1;  // Should be 8
    return res;
};

// Test 5: Division with error handling
func:divide = int8(int8:a, int8:b) {
    return {err:0, val:a/b};  // Simplified - no error checking for now
};

func:test_divide = *int8() {
    int8:r1 = divide(10, 2) ? -1;  // Should be 5
    return r1;  // Just return the result
};

// Module-level test execution
func:main = *int8() {
    int8:t1 = test_unwrap_success() ? -1;  // 42
    int8:t2 = test_unwrap_error() ? -1;    // -1
    int8:t3 = test_unwrap_chain() ? -1;    // 60
    int8:t4 = test_autowrap_unwrap() ? -1; // 8
    int8:t5 = test_divide() ? -1;          // 4
    
    print("All unwrap tests complete!");
    return 0;
};
